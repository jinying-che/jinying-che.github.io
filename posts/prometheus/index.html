<!doctype html><html lang=en><head><title>Prometheus Overview ::</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Prometheus Overview"><meta name=keywords content="computer,ai,network"><meta name=robots content="noodp"><link rel=canonical href=https://chejinying.com/tech/posts/prometheus/><link rel=stylesheet href=https://chejinying.com/tech/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://chejinying.com/tech/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://chejinying.com/tech/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://chejinying.com/tech/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://chejinying.com/tech/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://chejinying.com/tech/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://chejinying.com/tech/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://chejinying.com/tech/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://chejinying.com/tech/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://chejinying.com/tech/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://chejinying.com/tech/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://chejinying.com/tech/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://chejinying.com/tech/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://chejinying.com/tech/terminal.css><link rel="shortcut icon" href=https://chejinying.com/tech/favicon.png><link rel=apple-touch-icon href=https://chejinying.com/tech/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus Overview"><meta property="og:description" content="Prometheus Overview"><meta property="og:url" content="https://chejinying.com/tech/posts/prometheus/"><meta property="og:site_name" content><meta property="og:image" content="https://chejinying.com/tech/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-12-31 09:41:04 +0800 +0800"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=https://chejinying.com/tech/><div class=logo>jinying-che:~#</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://chejinying.com/tech/posts>Home</a></li><li><a href=https://chejinying.com/tech/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://chejinying.com/tech/posts>Home</a></li><li><a href=https://chejinying.com/tech/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://chejinying.com/tech/posts/prometheus/>Prometheus Overview</a></h1><div class=post-meta><time class=post-date>2023-12-31</time></div><span class=post-tags>#<a href=https://chejinying.com/tech/tags/monitor/>monitor</a>&nbsp;
#<a href=https://chejinying.com/tech/tags/prometheus/>prometheus</a>&nbsp;</span><div class=post-content><div><h2 id=architecture>Architecture<a href=#architecture class=hanchor arialabel=Anchor>#</a></h2><p><img src=https://chejinying.com/tech/images/prometheus.png alt=Architecture></p><h2 id=quick-start>Quick Start<a href=#quick-start class=hanchor arialabel=Anchor>#</a></h2><h2 id=data-model>Data Model<a href=#data-model class=hanchor arialabel=Anchor>#</a></h2><p>Every time series is uniquely identified by its <strong>metric name</strong> and optional key-value pairs called <strong>labels</strong>.</p><ul><li>Metric Name</li><li>Metric Label<ul><li>The change of any labels value, including adding or removing labels, will create a new time series.</li></ul></li></ul><h4 id=metric-type>Metric Type<a href=#metric-type class=hanchor arialabel=Anchor>#</a></h4><p>Prometheus supports four types of metrics, which are - Counter - Gauge - Histogram - Summary</p><ul><li>Counter: a metric value that can only increase or reset<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># use a counter to represent the number of requests served, tasks completed, or errors</span>
</span></span><span class=line><span class=cl>- http_requests_total<span class=o>{</span><span class=nv>handler</span><span class=o>=</span><span class=s1>&#39;/get_user_id&#39;</span>, <span class=nv>method</span><span class=o>=</span><span class=s1>&#39;GET&#39;</span>, <span class=nv>status</span><span class=o>=</span><span class=s1>&#39;200&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>- errors_total<span class=o>{</span><span class=nv>type</span><span class=o>=</span><span class=s1>&#39;runtime&#39;</span>, <span class=nv>severity</span><span class=o>=</span><span class=s1>&#39;critical&#39;</span><span class=o>}</span>
</span></span></code></pre></div></li><li>Gauge: a number which can either go up or down<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># used for measured values like temperatures or current memory usage</span>
</span></span><span class=line><span class=cl>- memory_usage_bytes<span class=o>{</span><span class=nv>process_name</span><span class=o>=</span><span class=s1>&#39;web_server&#39;</span>, <span class=nv>instance</span><span class=o>=</span><span class=s1>&#39;10.0.0.1:8080&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>- queue_size<span class=o>{</span><span class=nv>queue_name</span><span class=o>=</span><span class=s1>&#39;low_priority&#39;</span>, <span class=nv>worker_type</span><span class=o>=</span><span class=s1>&#39;background&#39;</span><span class=o>}</span>
</span></span></code></pre></div></li><li>Histogram: used for any calculated value which is counted based on bucket values,<ul><li><strong>bucket</strong> value determines the ordinate value (y coordinate of a standard two-dimensional graph)</li><li><strong>cumulative</strong> counters for the observation buckets, exposed as _bucket{le="&lt;<strong>upper</strong> inclusive bound>"}</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># usually things like request durations or response sizes</span>
</span></span><span class=line><span class=cl><span class=c1># le=&#34;0.3&#34; means less or equal to 0.3</span>
</span></span><span class=line><span class=cl>http_latency_sum 134420.14452212452
</span></span><span class=line><span class=cl>http_latency_second_bucket<span class=o>{</span><span class=nv>le</span><span class=o>=</span><span class=s2>&#34;0.05&#34;</span><span class=o>}</span> 11326.0
</span></span><span class=line><span class=cl>http_latency_second_bucket<span class=o>{</span><span class=nv>le</span><span class=o>=</span><span class=s2>&#34;0.1&#34;</span><span class=o>}</span> 2.284831e+06
</span></span><span class=line><span class=cl>http_latency_second_bucket<span class=o>{</span><span class=nv>le</span><span class=o>=</span><span class=s2>&#34;0.15&#34;</span><span class=o>}</span> 2.285367e+06
</span></span><span class=line><span class=cl>http_latency_second_bucket<span class=o>{</span><span class=nv>le</span><span class=o>=</span><span class=s2>&#34;0.25&#34;</span><span class=o>}</span> 2.285592e+06
</span></span><span class=line><span class=cl>http_latency_second_bucket<span class=o>{</span><span class=nv>le</span><span class=o>=</span><span class=s2>&#34;1.0&#34;</span><span class=o>}</span> 2.285613e+06
</span></span><span class=line><span class=cl>http_latency_second_bucket<span class=o>{</span><span class=nv>le</span><span class=o>=</span><span class=s2>&#34;+Inf&#34;</span><span class=o>}</span> 2.285619e+06
</span></span><span class=line><span class=cl>http_latency_count 2.285619e+06
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cumulative means that the count for le=”0.5” bucket also includes the count for le=”0.25” bucket.</span>
</span></span><span class=line><span class=cl><span class=c1># Consider the following hypothetical distribution of observations for 200 observations.</span>
</span></span><span class=line><span class=cl>┌─────────────┬──────────────────────┬──────────────────┐
</span></span><span class=line><span class=cl>│ Bucket Size │ Cumulative Frequency │ Upper Bound      │
</span></span><span class=line><span class=cl>│             │ Count                │ Percentile       │
</span></span><span class=line><span class=cl>├─────────────┼──────────────────────┼──────────────────┤
</span></span><span class=line><span class=cl>│ 50ms        │                   <span class=m>20</span> │ p10              │
</span></span><span class=line><span class=cl>│ 100ms       │                   <span class=m>70</span> │ p35              │
</span></span><span class=line><span class=cl>│ 250ms       │                  <span class=m>120</span> │ p60              │
</span></span><span class=line><span class=cl>│ 500ms       │                  <span class=m>150</span> │ p75              │
</span></span><span class=line><span class=cl>│ 1000ms      │                  <span class=m>200</span> │ p100             │
</span></span><span class=line><span class=cl>│ INF         │                  <span class=m>200</span> │ p100             │
</span></span><span class=line><span class=cl>└─────────────┴──────────────────────┴──────────────────┘
</span></span></code></pre></div></li><li>Summary: measure events and are an alternative to histograms. They are cheaper but lose more data (it is highly recommended to use histograms over summaries whenever possible.)</li></ul><h2 id=storage>Storage<a href=#storage class=hanchor arialabel=Anchor>#</a></h2><p><img src=https://chejinying.com/tech/images/tsdb_write.png alt=workflow></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>./data
</span></span><span class=line><span class=cl>├── 01BKGV7JBM69T2G1BGBGM6KB12
</span></span><span class=line><span class=cl>│   └── meta.json
</span></span><span class=line><span class=cl>├── 01BKGTZQ1SYQJTR4PB43C8PD98 
</span></span><span class=line><span class=cl>│   ├── chunks                 
</span></span><span class=line><span class=cl>│   │   └── 000001
</span></span><span class=line><span class=cl>│   ├── tombstones
</span></span><span class=line><span class=cl>│   ├── index                  
</span></span><span class=line><span class=cl>│   └── meta.json
</span></span><span class=line><span class=cl>├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K
</span></span><span class=line><span class=cl>│   └── meta.json
</span></span><span class=line><span class=cl>├── 01BKGV7JC0RY8A6MACW02A2PJD
</span></span><span class=line><span class=cl>│   ├── chunks
</span></span><span class=line><span class=cl>│   │   └── 000001
</span></span><span class=line><span class=cl>│   ├── tombstones
</span></span><span class=line><span class=cl>│   ├── index
</span></span><span class=line><span class=cl>│   └── meta.json
</span></span><span class=line><span class=cl>├── chunks_head
</span></span><span class=line><span class=cl>│   └── 000001
</span></span><span class=line><span class=cl>└── wal
</span></span><span class=line><span class=cl>    ├── 000000002
</span></span><span class=line><span class=cl>    └── checkpoint.00000001
</span></span><span class=line><span class=cl>        └── 00000000
</span></span></code></pre></div><p>see <a href=https://prometheus.io/docs/prometheus/latest/storage/#on-disk-layout>detals</a>, simple put:</p><ul><li><code>blocks</code>: ingested samples are grouped into blocks of 2 hours, e.g. <em>01BKGV7JBM69T2G1BGBGM6KB12</em> is a block</li><li><code>chunks</code>:<ul><li>it&rsquo;s a directory that contains the time series data for that window of time (up to 2 hours)</li><li>The samples in the chunks directory are grouped together into one or more segment files of up to 512MB each by default</li></ul></li><li><code>tombstones</code>: marked deletion records (instead of deleting the data immediately from the chunk segments)</li><li><code>index</code>: <strong>inverted index</strong> which indexes metric names and labels to time series in the chunks directory</li><li><code>meta.json</code>: block info</li><li><code>wal</code>(write-ahead log):<ul><li>The current block for incoming samples is kept in memory and is not fully persisted. It is secured against crashes by a write-ahead log (WAL) that can be replayed when the Prometheus server restarts.</li><li>files are stored in the wal directory in 128MB segments, which are significantly larger than regular block files (not yet been compacted)</li><li>minimum of 3 write-ahead log files. High-traffic servers may retain more than 3 WAL files in order to keep at least 2 hours of raw data.</li></ul></li></ul><h2 id=promql>PromQL<a href=#promql class=hanchor arialabel=Anchor>#</a></h2><h4 id=time-series-selectors>Time series Selectors<a href=#time-series-selectors class=hanchor arialabel=Anchor>#</a></h4><p><strong>Instant Vector</strong></p><p>Instant vector selectors allow the selection of a set of time series and a single sample value for each at a given timestamp (instant)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># only metric name</span>
</span></span><span class=line><span class=cl>http_requests_total
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># with labels</span>
</span></span><span class=line><span class=cl>http_requests_total<span class=o>{</span><span class=nv>job</span><span class=o>=</span><span class=s2>&#34;prometheus&#34;</span>,group<span class=o>=</span><span class=s2>&#34;canary&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># with regex</span>
</span></span><span class=line><span class=cl>http_requests_total<span class=o>{</span><span class=nv>environment</span><span class=o>=</span>~<span class=s2>&#34;staging|testing|development&#34;</span>,method!<span class=o>=</span><span class=s2>&#34;GET&#34;</span><span class=o>}</span>
</span></span></code></pre></div><p><strong>Range Vector Selectors</strong></p><p>Range vector literals work like instant vector literals, except that they select a range of samples back from the current instant</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>http_requests_total<span class=o>{</span><span class=nv>job</span><span class=o>=</span><span class=s2>&#34;prometheus&#34;</span><span class=o>}[</span>5m<span class=o>]</span>
</span></span></code></pre></div><p><strong>Offset Modifier</strong></p><p>The offset modifier allows changing the time offset for individual <strong>instant</strong> and <strong>range</strong> vectors in a query.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># returns the 5-minute rate that http_requests_total had a week ago</span>
</span></span><span class=line><span class=cl>rate<span class=o>(</span>http_requests_total<span class=o>[</span>5m<span class=o>]</span> offset 1w<span class=o>)</span>
</span></span></code></pre></div><h4 id=functions>Functions<a href=#functions class=hanchor arialabel=Anchor>#</a></h4><p>There are some common functions in PromQL which are used in most popular queries and scenarios.</p><h5 id=1-rate--irate>1. rate() && irate()<a href=#1-rate--irate class=hanchor arialabel=Anchor>#</a></h5><p><a href=https://jinying-che.github.io/posts/rate_vs_irate/>see details</a></p><h6 id=2-histogram_quantile>2. histogram_quantile()<a href=#2-histogram_quantile class=hanchor arialabel=Anchor>#</a></h6><p>How P99 is calculated?</p><h2 id=reference>Reference<a href=#reference class=hanchor arialabel=Anchor>#</a></h2><ul><li><a href=https://prometheus.io/docs/introduction/overview/>https://prometheus.io/docs/introduction/overview/</a></li><li><a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>https://prometheus.io/docs/prometheus/latest/querying/basics/</a></li><li><a href=https://promlabs.com/blog/2023/08/31/high-availability-for-prometheus-and-alertmanager-an-overview/>https://promlabs.com/blog/2023/08/31/high-availability-for-prometheus-and-alertmanager-an-overview/</a></li><li><a href="https://docs.google.com/presentation/d/1TMvzwdaS8Vw9MtscI9ehDyiMngII8iB_Z5D4QW4U4ho/edit?pli=1#slide=id.gae9988762_0_0">PromCon 2016 - The Prometheus TSDB Slides</a></li><li><a href=https://zhenghe-md.github.io/blog/2020/02/27/The-Evolution-of-Prometheus-Storage-Layer/>The Evolution of Prometheus Storage Layer</a></li><li><a href=https://ganeshvernekar.com/blog/prometheus-tsdb-the-head-block/>Prometheus TSDB</a></li><li><a href=https://web.archive.org/web/20210803115658/https://fabxc.org/tsdb>Writing a Time Series Database from Scratch</a></li><li><a href="https://news.ycombinator.com/item?id=27730854">Write a time-series database engine from scratch (hancker news)</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://chejinying.com/tech/posts/vm/victorial_metrics/ class="button inline prev">&lt; [<span class=button__text>Victorial Metrics</span>]
</a>::
<a href=https://chejinying.com/tech/posts/cap/ class="button inline next">[<span class=button__text>CAP</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=https://chejinying.com/tech/bundle.min.js></script></div></body></html>