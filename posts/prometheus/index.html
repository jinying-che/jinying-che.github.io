<!doctype html><html lang=en><head><title>Prometheus Overview :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Prometheus Overview"><meta name=keywords content="computer,ai,network"><meta name=robots content="noodp"><link rel=canonical href=https://jinying-che.github.io/posts/prometheus/><link rel=stylesheet href=https://jinying-che.github.io/styles.css><link rel="shortcut icon" href=https://jinying-che.github.io/img/theme-colors/green.png><link rel=apple-touch-icon href=https://jinying-che.github.io/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus Overview"><meta property="og:description" content="Prometheus Overview"><meta property="og:url" content="https://jinying-che.github.io/posts/prometheus/"><meta property="og:site_name" content><meta property="og:image" content="https://jinying-che.github.io/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-12-31 09:41:04 +0800 +0800"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>jinying-che:~#</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/posts>Home</a></li><li><a href=/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/posts>Home</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://jinying-che.github.io/posts/prometheus/>Prometheus Overview</a></h1><div class=post-meta><time class=post-date>2023-12-31 ::</time></div><span class=post-tags>#<a href=https://jinying-che.github.io/tags/monitor/>monitor</a>&nbsp;
#<a href=https://jinying-che.github.io/tags/prometheus/>prometheus</a>&nbsp;</span><div class=post-content><div><h2 id=architecture>Architecture<a href=#architecture class=hanchor arialabel=Anchor>&#8983;</a></h2><p><img alt=Architecture src=/images/prometheus.png></p><h2 id=quick-start>Quick Start<a href=#quick-start class=hanchor arialabel=Anchor>&#8983;</a></h2><h2 id=data-model>Data Model<a href=#data-model class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Every time series is uniquely identified by its <strong>metric name</strong> and optional key-value pairs called <strong>labels</strong>.</p><ul><li>Metric Name</li><li>Metric Label<ul><li>The change of any labels value, including adding or removing labels, will create a new time series.</li></ul></li></ul><h4 id=metric-type>Metric Type<a href=#metric-type class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Prometheus supports four types of metrics, which are - Counter - Gauge - Histogram - Summary</p><ul><li>Counter: a metric value that can only increase or reset<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># use a counter to represent the number of requests served, tasks completed, or errors</span>
</span></span><span style=display:flex><span>- http_requests_total<span style=color:#f92672>{</span>handler<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/get_user_id&#39;</span>, method<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;GET&#39;</span>, status<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;200&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>- errors_total<span style=color:#f92672>{</span>type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;runtime&#39;</span>, severity<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;critical&#39;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li>Gauge: a number which can either go up or down<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># used for measured values like temperatures or current memory usage</span>
</span></span><span style=display:flex><span>- memory_usage_bytes<span style=color:#f92672>{</span>process_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;web_server&#39;</span>, instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;10.0.0.1:8080&#39;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>- queue_size<span style=color:#f92672>{</span>queue_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;low_priority&#39;</span>, worker_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;background&#39;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li>Histogram: used for any calculated value which is counted based on bucket values,<ul><li><strong>bucket</strong> value determines the ordinate value (y coordinate of a standard two-dimensional graph)</li><li><strong>cumulative</strong> counters for the observation buckets, exposed as _bucket{le="&lt;<strong>upper</strong> inclusive bound>"}</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># usually things like request durations or response sizes</span>
</span></span><span style=display:flex><span><span style=color:#75715e># le=&#34;0.3&#34; means less or equal to 0.3</span>
</span></span><span style=display:flex><span>http_latency_sum 134420.14452212452
</span></span><span style=display:flex><span>http_latency_second_bucket<span style=color:#f92672>{</span>le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.05&#34;</span><span style=color:#f92672>}</span> 11326.0
</span></span><span style=display:flex><span>http_latency_second_bucket<span style=color:#f92672>{</span>le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.1&#34;</span><span style=color:#f92672>}</span> 2.284831e+06
</span></span><span style=display:flex><span>http_latency_second_bucket<span style=color:#f92672>{</span>le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.15&#34;</span><span style=color:#f92672>}</span> 2.285367e+06
</span></span><span style=display:flex><span>http_latency_second_bucket<span style=color:#f92672>{</span>le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.25&#34;</span><span style=color:#f92672>}</span> 2.285592e+06
</span></span><span style=display:flex><span>http_latency_second_bucket<span style=color:#f92672>{</span>le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span><span style=color:#f92672>}</span> 2.285613e+06
</span></span><span style=display:flex><span>http_latency_second_bucket<span style=color:#f92672>{</span>le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;+Inf&#34;</span><span style=color:#f92672>}</span> 2.285619e+06
</span></span><span style=display:flex><span>http_latency_count 2.285619e+06
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># cumulative means that the count for le=”0.5” bucket also includes the count for le=”0.25” bucket.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Consider the following hypothetical distribution of observations for 200 observations.</span>
</span></span><span style=display:flex><span>┌─────────────┬──────────────────────┬──────────────────┐
</span></span><span style=display:flex><span>│ Bucket Size │ Cumulative Frequency │ Upper Bound      │
</span></span><span style=display:flex><span>│             │ Count                │ Percentile       │
</span></span><span style=display:flex><span>├─────────────┼──────────────────────┼──────────────────┤
</span></span><span style=display:flex><span>│ 50ms        │                   <span style=color:#ae81ff>20</span> │ p10              │
</span></span><span style=display:flex><span>│ 100ms       │                   <span style=color:#ae81ff>70</span> │ p35              │
</span></span><span style=display:flex><span>│ 250ms       │                  <span style=color:#ae81ff>120</span> │ p60              │
</span></span><span style=display:flex><span>│ 500ms       │                  <span style=color:#ae81ff>150</span> │ p75              │
</span></span><span style=display:flex><span>│ 1000ms      │                  <span style=color:#ae81ff>200</span> │ p100             │
</span></span><span style=display:flex><span>│ INF         │                  <span style=color:#ae81ff>200</span> │ p100             │
</span></span><span style=display:flex><span>└─────────────┴──────────────────────┴──────────────────┘
</span></span></code></pre></div></li><li>Summary: measure events and are an alternative to histograms. They are cheaper but lose more data (it is highly recommended to use histograms over summaries whenever possible.)</li></ul><h2 id=storage>Storage<a href=#storage class=hanchor arialabel=Anchor>&#8983;</a></h2><p><img alt=workflow src=/images/tsdb_write.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>./data
</span></span><span style=display:flex><span>├── 01BKGV7JBM69T2G1BGBGM6KB12
</span></span><span style=display:flex><span>│   └── meta.json
</span></span><span style=display:flex><span>├── 01BKGTZQ1SYQJTR4PB43C8PD98 
</span></span><span style=display:flex><span>│   ├── chunks                 
</span></span><span style=display:flex><span>│   │   └── 000001
</span></span><span style=display:flex><span>│   ├── tombstones
</span></span><span style=display:flex><span>│   ├── index                  
</span></span><span style=display:flex><span>│   └── meta.json
</span></span><span style=display:flex><span>├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K
</span></span><span style=display:flex><span>│   └── meta.json
</span></span><span style=display:flex><span>├── 01BKGV7JC0RY8A6MACW02A2PJD
</span></span><span style=display:flex><span>│   ├── chunks
</span></span><span style=display:flex><span>│   │   └── 000001
</span></span><span style=display:flex><span>│   ├── tombstones
</span></span><span style=display:flex><span>│   ├── index
</span></span><span style=display:flex><span>│   └── meta.json
</span></span><span style=display:flex><span>├── chunks_head
</span></span><span style=display:flex><span>│   └── 000001
</span></span><span style=display:flex><span>└── wal
</span></span><span style=display:flex><span>    ├── 000000002
</span></span><span style=display:flex><span>    └── checkpoint.00000001
</span></span><span style=display:flex><span>        └── 00000000
</span></span></code></pre></div><ul><li><code>blocks</code>: ingested samples are grouped into blocks of two hours, e.g. <em>01BKGV7JBM69T2G1BGBGM6KB12</em> is a block</li><li><code>chunks</code>: all the time series samples for that window of time</li><li><code>tombstones</code>: marked deletion records (instead of deleting the data immediately from the chunk segments)</li><li><code>index</code>: <strong>inverted index</strong> which indexes metric names and labels to time series in the chunks directory</li><li><code>meta.json</code>: block info</li></ul><h2 id=promql>PromQL<a href=#promql class=hanchor arialabel=Anchor>&#8983;</a></h2><h4 id=time-series-selectors>Time series Selectors<a href=#time-series-selectors class=hanchor arialabel=Anchor>&#8983;</a></h4><p><strong>Instant Vector</strong></p><p>Instant vector selectors allow the selection of a set of time series and a single sample value for each at a given timestamp (instant)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># only metric name</span>
</span></span><span style=display:flex><span>http_requests_total
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># with labels</span>
</span></span><span style=display:flex><span>http_requests_total<span style=color:#f92672>{</span>job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;prometheus&#34;</span>,group<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;canary&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># with regex</span>
</span></span><span style=display:flex><span>http_requests_total<span style=color:#f92672>{</span>environment<span style=color:#f92672>=</span>~<span style=color:#e6db74>&#34;staging|testing|development&#34;</span>,method!<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;GET&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>Range Vector Selectors</strong></p><p>Range vector literals work like instant vector literals, except that they select a range of samples back from the current instant</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>http_requests_total<span style=color:#f92672>{</span>job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;prometheus&#34;</span><span style=color:#f92672>}[</span>5m<span style=color:#f92672>]</span>
</span></span></code></pre></div><p><strong>Offset Modifier</strong></p><p>The offset modifier allows changing the time offset for individual <strong>instant</strong> and **range vectors in a query.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># returns the 5-minute rate that http_requests_total had a week ago</span>
</span></span><span style=display:flex><span>rate<span style=color:#f92672>(</span>http_requests_total<span style=color:#f92672>[</span>5m<span style=color:#f92672>]</span> offset 1w<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=functions>Functions<a href=#functions class=hanchor arialabel=Anchor>&#8983;</a></h4><h2 id=reference>Reference<a href=#reference class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><a href=https://prometheus.io/docs/introduction/overview/>https://prometheus.io/docs/introduction/overview/</a></li><li><a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>https://prometheus.io/docs/prometheus/latest/querying/basics/</a></li><li><a href=https://promlabs.com/blog/2023/08/31/high-availability-for-prometheus-and-alertmanager-an-overview/>https://promlabs.com/blog/2023/08/31/high-availability-for-prometheus-and-alertmanager-an-overview/</a></li><li><a href="https://docs.google.com/presentation/d/1TMvzwdaS8Vw9MtscI9ehDyiMngII8iB_Z5D4QW4U4ho/edit?pli=1#slide=id.gae9988762_0_0">PromCon 2016 - The Prometheus TSDB Slides</a></li><li><a href=https://zhenghe-md.github.io/blog/2020/02/27/The-Evolution-of-Prometheus-Storage-Layer/>The Evolution of Prometheus Storage Layer</a></li><li><a href=https://ganeshvernekar.com/blog/prometheus-tsdb-the-head-block/>Prometheus TSDB</a></li><li><a href=https://web.archive.org/web/20210803115658/https://fabxc.org/tsdb>Writing a Time Series Database from Scratch</a></li><li><a href="https://news.ycombinator.com/item?id=27730854">Write a time-series database engine from scratch (hancker news)</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://jinying-che.github.io/posts/go/gorm/gorm/><span class=button__icon>←</span>
<span class=button__text>GORM</span>
</a></span><span class="button next"><a href=https://jinying-che.github.io/posts/cap/><span class=button__text>CAP</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>