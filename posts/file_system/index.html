<!doctype html><html lang=en><head><title>File System ::</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="File System Overview"><meta name=keywords content="computer,ai,network"><meta name=robots content="noodp"><link rel=canonical href=https://chejinying.com/tech/posts/file_system/><link rel=stylesheet href=https://chejinying.com/tech/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://chejinying.com/tech/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://chejinying.com/tech/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://chejinying.com/tech/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://chejinying.com/tech/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://chejinying.com/tech/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://chejinying.com/tech/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://chejinying.com/tech/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://chejinying.com/tech/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://chejinying.com/tech/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://chejinying.com/tech/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://chejinying.com/tech/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://chejinying.com/tech/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://chejinying.com/tech/terminal.css><link rel="shortcut icon" href=https://chejinying.com/tech/favicon.png><link rel=apple-touch-icon href=https://chejinying.com/tech/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="File System"><meta property="og:description" content="File System Overview"><meta property="og:url" content="https://chejinying.com/tech/posts/file_system/"><meta property="og:site_name" content><meta property="og:image" content="https://chejinying.com/tech/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-09-30 15:25:41 +0800 +0800"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=https://chejinying.com/tech/><div class=logo>jinying-che:~#</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://chejinying.com/tech/posts>Home</a></li><li><a href=https://chejinying.com/tech/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://chejinying.com/tech/posts>Home</a></li><li><a href=https://chejinying.com/tech/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://chejinying.com/tech/posts/file_system/>File System</a></h1><div class=post-meta><time class=post-date>2023-09-30</time></div><span class=post-tags>#<a href=https://chejinying.com/tech/tags/linux/>linux</a>&nbsp;</span><div class=post-content><div><h2 id=architecture>Architecture<a href=#architecture class=hanchor arialabel=Anchor>#</a></h2><p><img src=https://chejinying.com/tech/images/linux_file_system.svg alt="file system"></p><h2 id=vfs>VFS<a href=#vfs class=hanchor arialabel=Anchor>#</a></h2><p>The Virtual File System (also known as the Virtual Filesystem Switch) is the software layer in the kernel that provides the filesystem interface to userspace programs via system call. It also provides an abstraction within the kernel which allows different filesystem implementations to coexist.</p><p>A VFS specifies an interface (or a &ldquo;contract&rdquo;) between the kernel and a concrete file system. Therefore, it is easy to add support for new file system types to the kernel simply by fulfilling the contract.</p><h4 id=superblock>Superblock<a href=#superblock class=hanchor arialabel=Anchor>#</a></h4><p>The superblock records various information about the enclosing filesystem, such as block counts, inode counts, supported features, maintenance information, and more.</p><p>Show the super block info in Linux:</p><blockquote><p>all examples in this post are from my vps (OS: Ubuntu 22.04.2 LTS)</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ df -h
</span></span><span class=line><span class=cl>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span class=line><span class=cl>tmpfs            96M  1.3M   95M   2% /run
</span></span><span class=line><span class=cl>/dev/vda1        24G   12G   11G  52% /
</span></span><span class=line><span class=cl>tmpfs           479M     <span class=m>0</span>  479M   0% /dev/shm
</span></span><span class=line><span class=cl>tmpfs           5.0M     <span class=m>0</span>  5.0M   0% /run/lock
</span></span><span class=line><span class=cl>tmpfs            96M  4.0K   96M   1% /run/user/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ dumpe2fs /dev/vda1
</span></span><span class=line><span class=cl>dumpe2fs 1.46.5 <span class=o>(</span>30-Dec-2021<span class=o>)</span>
</span></span><span class=line><span class=cl>Filesystem volume name:   &lt;none&gt;
</span></span><span class=line><span class=cl>Last mounted on:          /
</span></span><span class=line><span class=cl>Filesystem UUID:          cc673143-6902-4174-990e-8cba0304cb7a
</span></span><span class=line><span class=cl>Filesystem magic number:  0xEF53
</span></span><span class=line><span class=cl>Filesystem revision <span class=c1>#:    1 (dynamic)</span>
</span></span><span class=line><span class=cl>Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum
</span></span><span class=line><span class=cl>Filesystem flags:         signed_directory_hash
</span></span><span class=line><span class=cl>Default mount options:    user_xattr acl discard
</span></span><span class=line><span class=cl>Filesystem state:         clean
</span></span><span class=line><span class=cl>Errors behavior:          Continue
</span></span><span class=line><span class=cl>Filesystem OS type:       Linux
</span></span><span class=line><span class=cl>Inode count:              <span class=m>6537600</span>
</span></span><span class=line><span class=cl>Block count:              <span class=m>6553339</span>
</span></span><span class=line><span class=cl>Reserved block count:     <span class=m>327666</span>
</span></span><span class=line><span class=cl>Free blocks:              <span class=m>3333553</span>
</span></span><span class=line><span class=cl>Free inodes:              <span class=m>6325191</span>
</span></span><span class=line><span class=cl>First block:              <span class=m>0</span>
</span></span><span class=line><span class=cl>Block size:               <span class=m>4096</span>
</span></span><span class=line><span class=cl>Fragment size:            <span class=m>4096</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p><code>Source Code</code>: <a href=https://github.com/torvalds/linux/blob/b9ddbb0cde2adcedda26045cc58f31316a492215/include/linux/fs.h#L1188>super_block c source code</a></p><h4 id=directory-entry-dentry>Directory Entry (Dentry)<a href=#directory-entry-dentry class=hanchor arialabel=Anchor>#</a></h4><ol><li>Dentry is used by VFS to represent information about the <strong>directories and files</strong> inside the <strong>memory</strong></li><li>Dentries live in RAM and are never saved to disc: they exist only for performance. (RAM cannot save all dentries -> LFU cache)</li><li>An individual dentry usually has a pointer to an inode</li><li>It&rsquo;s a fast look-up mechanism to translate a pathname (filename) into a specific <strong>dentry</strong> then <strong>inode</strong></li></ol><p><code>Source Code</code>: <a href=https://github.com/torvalds/linux/blob/b9ddbb0cde2adcedda26045cc58f31316a492215/include/linux/dcache.h#L82>dentry c source code</a></p><h4 id=index-node>Index Node<a href=#index-node class=hanchor arialabel=Anchor>#</a></h4><ol><li>Index node(Inode) is a data structure that stores ownership, permissions, file size, and other metadata-related terms.</li><li>They live either on the disc (for block device filesystems) or in the memory (for pseudo filesystems). Inodes that live on the disc are copied into the memory when required and changes to the inode are written back to disc.</li><li>Every file and directory on Linux is represented by a unique inode number used by the system to identify it on the file system.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># ls</span>
</span></span><span class=line><span class=cl><span class=c1>#   -i, --inode</span>
</span></span><span class=line><span class=cl><span class=c1>#     print the index number of each file</span>
</span></span><span class=line><span class=cl>$ ls -i workspace/main.go
</span></span><span class=line><span class=cl><span class=m>1067025</span> workspace/main.go
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ls -i workspace
</span></span><span class=line><span class=cl><span class=m>1067025</span> main.go
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stat - display file or file system status</span>
</span></span><span class=line><span class=cl>$ stat workspace/main.go
</span></span><span class=line><span class=cl>  File: workspace/main.go
</span></span><span class=line><span class=cl>  Size: <span class=m>72</span>              Blocks: <span class=m>8</span>          IO Block: <span class=m>4096</span>   regular file
</span></span><span class=line><span class=cl>Device: fc01h/64513d    Inode: <span class=m>1067025</span>     Links: <span class=m>1</span>
</span></span><span class=line><span class=cl>Access: <span class=o>(</span>0644/-rw-r--r--<span class=o>)</span>  Uid: <span class=o>(</span>    0/    root<span class=o>)</span>   Gid: <span class=o>(</span>    0/    root<span class=o>)</span>
</span></span><span class=line><span class=cl>Access: 2023-10-09 22:12:30.884848072 +0800
</span></span><span class=line><span class=cl>Modify: 2023-06-11 22:44:14.194331022 +0800
</span></span><span class=line><span class=cl>Change: 2023-06-11 22:44:14.194331022 +0800
</span></span><span class=line><span class=cl> Birth: 2023-06-11 22:44:14.194331022 +0800
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ stat workspace
</span></span><span class=line><span class=cl>  File: workspace
</span></span><span class=line><span class=cl>  Size: <span class=m>4096</span>            Blocks: <span class=m>8</span>          IO Block: <span class=m>4096</span>   directory
</span></span><span class=line><span class=cl>Device: fc01h/64513d    Inode: <span class=m>1066674</span>     Links: <span class=m>2</span>
</span></span><span class=line><span class=cl>Access: <span class=o>(</span>0755/drwxr-xr-x<span class=o>)</span>  Uid: <span class=o>(</span>    0/    root<span class=o>)</span>   Gid: <span class=o>(</span>    0/    root<span class=o>)</span>
</span></span><span class=line><span class=cl>Access: 2023-10-09 22:12:33.196939026 +0800
</span></span><span class=line><span class=cl>Modify: 2023-10-09 22:12:32.612916118 +0800
</span></span><span class=line><span class=cl>Change: 2023-10-09 22:12:32.612916118 +0800
</span></span><span class=line><span class=cl> Birth: 2023-06-11 22:43:01.453639583 +0800
</span></span></code></pre></div><p><code>Source Code</code>: <a href=https://github.com/torvalds/linux/blob/94f6f0550c625fab1f373bb86a6669b45e9748b3/include/linux/fs.h#L639>inode c source code</a></p><h4 id=file>File<a href=#file class=hanchor arialabel=Anchor>#</a></h4><ol><li>The file object is the in-memory representation of an open file.</li><li>The file object is initialized with a pointer to the dentry and a set of file operation member functions which are taken from the inode data.</li><li>The file structure is placed into the file descriptor table for the process.</li><li>Reading, writing and closing files are done by using the userspace <strong>file descriptor</strong> to grab the appropriate file structure.</li></ol><p><code>Source Code</code>: <a href=https://github.com/torvalds/linux/blob/b9ddbb0cde2adcedda26045cc58f31316a492215/include/linux/fs.h#L992>file c source code</a></p><h2 id=what-happens-when-reading-a-file-in-linux>What happens when reading a file in Linux?<a href=#what-happens-when-reading-a-file-in-linux class=hanchor arialabel=Anchor>#</a></h2><p>TBD Diagram to elaborate on the concepts above</p><h2 id=block-layer>Block Layer<a href=#block-layer class=hanchor arialabel=Anchor>#</a></h2><p>TBD</p><h2 id=troubleshooting>Troubleshooting<a href=#troubleshooting class=hanchor arialabel=Anchor>#</a></h2><h4 id=1-df--du>1. df & du<a href=#1-df--du class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># df displays the amount of disk space available on the file system containing each file name argument</span>
</span></span><span class=line><span class=cl>$ df -h
</span></span><span class=line><span class=cl>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span class=line><span class=cl>tmpfs            96M  1.3M   95M   2% /run
</span></span><span class=line><span class=cl>/dev/vda1        24G   12G   11G  52% /
</span></span><span class=line><span class=cl>tmpfs           479M     <span class=m>0</span>  479M   0% /dev/shm
</span></span><span class=line><span class=cl>tmpfs           5.0M     <span class=m>0</span>  5.0M   0% /run/lock
</span></span><span class=line><span class=cl>tmpfs            96M  4.0K   96M   1% /run/user/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># du Summarize disk usage of the set of FILEs, recursively for directories.</span>
</span></span><span class=line><span class=cl>/usr &gt; du -h --max-depth<span class=o>=</span><span class=m>1</span> <span class=c1># display the usage of first depth in a human readable format </span>
</span></span><span class=line><span class=cl>4.0K    ./lib32
</span></span><span class=line><span class=cl>32M     ./sbin
</span></span><span class=line><span class=cl>465M    ./src
</span></span><span class=line><span class=cl>4.0K    ./lib64
</span></span><span class=line><span class=cl>439M    ./share
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># display the usage of this depth and sort the output in a human readable format</span>
</span></span><span class=line><span class=cl>$ du -hs * <span class=p>|</span> sort -rh <span class=p>|</span> head -10 
</span></span><span class=line><span class=cl>5.0G    usr
</span></span><span class=line><span class=cl>3.9G    var
</span></span><span class=line><span class=cl>2.4G    swapfile
</span></span><span class=line><span class=cl>1.1G    snap
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h4 id=2-iostat-device-level>2. iostat (device level)<a href=#2-iostat-device-level class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># Display a continuous device report of extended statistics at two second intervals.</span>
</span></span><span class=line><span class=cl><span class=c1># take note of the following statistics: </span>
</span></span><span class=line><span class=cl><span class=c1># - %util: percentage of elapsed time during which I/O requests were issued to the device </span>
</span></span><span class=line><span class=cl><span class=c1># - r/s, w/s: read/write requests per second for the device</span>
</span></span><span class=line><span class=cl><span class=c1># - rKB/s, rWB/s: the number of sectors (kilobytes, megabytes) read/write for the device per second</span>
</span></span><span class=line><span class=cl><span class=c1># - r_await, w_await: the average time (in milliseconds) for read/write requests issued to the device to be served. This includes the time spent by the requests in queue and the time spent servicing them.</span>
</span></span><span class=line><span class=cl>$ iostat -x -d <span class=m>2</span>
</span></span><span class=line><span class=cl>Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util
</span></span><span class=line><span class=cl>loop0            0.00      0.02     0.00   0.00    0.29    47.11    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
</span></span><span class=line><span class=cl>loop1            0.00      0.00     0.00   0.00    0.14    34.80    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
</span></span><span class=line><span class=cl>sr0              0.00      0.00     0.00   0.00    0.00     0.12    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
</span></span><span class=line><span class=cl>vda              0.24      6.06     0.09  28.32    0.37    25.79    2.18     15.93     0.48  17.94    0.38     7.32    0.01      8.63     0.00   0.00    2.14  1258.27    0.20    0.14    0.00   0.10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util
</span></span><span class=line><span class=cl>loop0            0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
</span></span><span class=line><span class=cl>loop1            0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
</span></span><span class=line><span class=cl>sr0              0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
</span></span><span class=line><span class=cl>vda              0.00      0.00     0.00   0.00    0.00     0.00    1.00     30.00     6.50  86.67    0.50    30.00    0.50      2.00     0.00   0.00    2.00     4.00    1.00    0.00    0.00   0.20
</span></span></code></pre></div><h4 id=3-pidstat-process-level>3. pidstat (process level)<a href=#3-pidstat-process-level class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># pidstat - Report statistics for Linux tasks.</span>
</span></span><span class=line><span class=cl><span class=c1># -d report I/O statistics per second </span>
</span></span><span class=line><span class=cl>$ pidstat -d <span class=m>1</span> 
</span></span><span class=line><span class=cl>11:11:01 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
</span></span><span class=line><span class=cl>11:11:01 PM     <span class=m>0</span>       <span class=m>387</span>      0.00     16.00      0.00       <span class=m>0</span>  systemd-journal
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>11:11:01 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
</span></span><span class=line><span class=cl>11:11:02 PM     <span class=m>0</span>       <span class=m>387</span>      0.00     36.00      0.00       <span class=m>0</span>  systemd-journal
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>11:11:02 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
</span></span><span class=line><span class=cl>11:11:03 PM     <span class=m>0</span>       <span class=m>387</span>      0.00     32.00      0.00       <span class=m>0</span>  systemd-journal
</span></span><span class=line><span class=cl>11:11:03 PM     <span class=m>0</span>       <span class=m>825</span>      0.00      4.00      0.00       <span class=m>0</span>  sshd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ pidstat -d -p <span class=m>387</span> <span class=m>1</span> <span class=c1># report I/O statistics for process 387 per second </span>
</span></span><span class=line><span class=cl>11:11:24 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
</span></span><span class=line><span class=cl>11:11:25 PM     <span class=m>0</span>       <span class=m>387</span>      0.00     16.00      0.00       <span class=m>0</span>  systemd-journal
</span></span><span class=line><span class=cl>11:11:26 PM     <span class=m>0</span>       <span class=m>387</span>      0.00      0.00      0.00       <span class=m>0</span>  systemd-journal
</span></span><span class=line><span class=cl>11:11:27 PM     <span class=m>0</span>       <span class=m>387</span>      0.00     32.00      0.00       <span class=m>0</span>  systemd-journal
</span></span><span class=line><span class=cl>11:11:28 PM     <span class=m>0</span>       <span class=m>387</span>      0.00      0.00      0.00       <span class=m>0</span>  systemd-journal
</span></span></code></pre></div><h4 id=4-iotop>4. iotop<a href=#4-iotop class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># iotop - simple top-like I/O monitor</span>
</span></span><span class=line><span class=cl><span class=c1># NOTE: not handy as kernal config may need to update (at least the CONFIG_TASK_DELAY_ACCT, CONFIG_TASK_IO_ACCOUNTING, CON-FIG_TASKSTATS and CONFIG_VM_EVENT_COUNTERS options need to be enabled in your Linux kernel build configuration.)</span>
</span></span><span class=line><span class=cl>$ iotop
</span></span><span class=line><span class=cl>Total DISK READ :       0.00 B/s <span class=p>|</span> Total DISK WRITE :       7.85 K/s 
</span></span><span class=line><span class=cl>Actual DISK READ:       0.00 B/s <span class=p>|</span> Actual DISK WRITE:       0.00 B/s 
</span></span><span class=line><span class=cl>  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND 
</span></span><span class=line><span class=cl><span class=m>15055</span> be/3 root        0.00 B/s    7.85 K/s  0.00 %  0.00 % systemd-journald 
</span></span></code></pre></div><h4 id=5-strace>5. strace<a href=#5-strace class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># strace - trace system calls and signals</span>
</span></span><span class=line><span class=cl><span class=c1># process 654373 is a prometheus node exporter, through the strace (system calls), it&#39;s able to roughly understand how does node exporter work </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ strace -p <span class=m>654373</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>newfstatat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/proc&#34;</span>, <span class=o>{</span><span class=nv>st_mode</span><span class=o>=</span>S_IFDIR<span class=p>|</span>0555, <span class=nv>st_size</span><span class=o>=</span>0, ...<span class=o>}</span>, 0<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>statfs<span class=o>(</span><span class=s2>&#34;/proc&#34;</span>, <span class=o>{</span><span class=nv>f_type</span><span class=o>=</span>PROC_SUPER_MAGIC, <span class=nv>f_bsize</span><span class=o>=</span>4096, <span class=nv>f_blocks</span><span class=o>=</span>0, <span class=nv>f_bfree</span><span class=o>=</span>0, <span class=nv>f_bavail</span><span class=o>=</span>0, <span class=nv>f_files</span><span class=o>=</span>0, <span class=nv>f_ffree</span><span class=o>=</span>0, <span class=nv>f_fsid</span><span class=o>={</span><span class=nv>val</span><span class=o>=[</span>0, 0<span class=o>]}</span>, <span class=nv>f_namelen</span><span class=o>=</span>255, <span class=nv>f_frsize</span><span class=o>=</span>4096, <span class=nv>f_flags</span><span class=o>=</span>ST_VALID<span class=p>|</span>ST_NOSUID<span class=p>|</span>ST_NODEV<span class=p>|</span>ST_NOEXEC<span class=p>|</span>ST_RELATIME<span class=o>})</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>newfstatat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/proc/655152&#34;</span>, <span class=o>{</span><span class=nv>st_mode</span><span class=o>=</span>S_IFDIR<span class=p>|</span>0555, <span class=nv>st_size</span><span class=o>=</span>0, ...<span class=o>}</span>, 0<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/proc/655152/stat&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>8</span>
</span></span><span class=line><span class=cl>fcntl<span class=o>(</span>8, F_GETFL<span class=o>)</span>                       <span class=o>=</span> 0x8000 <span class=o>(</span>flags O_RDONLY<span class=p>|</span>O_LARGEFILE<span class=o>)</span>
</span></span><span class=line><span class=cl>fcntl<span class=o>(</span>8, F_SETFL, O_RDONLY<span class=p>|</span>O_NONBLOCK<span class=p>|</span>O_LARGEFILE<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>epoll_ctl<span class=o>(</span>4, EPOLL_CTL_ADD, 8, <span class=o>{</span><span class=nv>events</span><span class=o>=</span>EPOLLIN<span class=p>|</span>EPOLLOUT<span class=p>|</span>EPOLLRDHUP<span class=p>|</span>EPOLLET, <span class=nv>data</span><span class=o>={</span><span class=nv>u32</span><span class=o>=</span>1268860600, <span class=nv>u64</span><span class=o>=</span>139673605326520<span class=o>}})</span> <span class=o>=</span> -1 EPERM <span class=o>(</span>Operation not permitted<span class=o>)</span>
</span></span><span class=line><span class=cl>fcntl<span class=o>(</span>8, F_GETFL<span class=o>)</span>                       <span class=o>=</span> 0x8800 <span class=o>(</span>flags O_RDONLY<span class=p>|</span>O_NONBLOCK<span class=p>|</span>O_LARGEFILE<span class=o>)</span>
</span></span><span class=line><span class=cl>fcntl<span class=o>(</span>8, F_SETFL, O_RDONLY<span class=p>|</span>O_LARGEFILE<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>read<span class=o>(</span>8, <span class=s2>&#34;655152 (node_exporter) R 655107 &#34;</span>..., 512<span class=o>)</span> <span class=o>=</span> <span class=m>308</span>
</span></span><span class=line><span class=cl>read<span class=o>(</span>8, <span class=s2>&#34;&#34;</span>, 204<span class=o>)</span>                        <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>close<span class=o>(</span>8<span class=o>)</span>                                <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/proc/stat&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>8</span>
</span></span><span class=line><span class=cl>fcntl<span class=o>(</span>8, F_GETFL<span class=o>)</span>                       <span class=o>=</span> 0x8000 <span class=o>(</span>flags O_RDONLY<span class=p>|</span>O_LARGEFILE<span class=o>)</span>
</span></span><span class=line><span class=cl>fcntl<span class=o>(</span>8, F_SETFL, O_RDONLY<span class=p>|</span>O_NONBLOCK<span class=p>|</span>O_LARGEFILE<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>epoll_ctl<span class=o>(</span>4, EPOLL_CTL_ADD, 8, <span class=o>{</span><span class=nv>events</span><span class=o>=</span>EPOLLIN<span class=p>|</span>EPOLLOUT<span class=p>|</span>EPOLLRDHUP<span class=p>|</span>EPOLLET, <span class=nv>data</span><span class=o>={</span><span class=nv>u32</span><span class=o>=</span>1268860600, <span class=nv>u64</span><span class=o>=</span>139673605326520<span class=o>}})</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>read<span class=o>(</span>8, <span class=s2>&#34;cpu  773459 68488 441098 3776333&#34;</span>..., 512<span class=o>)</span> <span class=o>=</span> <span class=m>512</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h4 id=6-lsof>6. lsof<a href=#6-lsof class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># lsof - lists on its standard output file information about files opened by processes</span>
</span></span><span class=line><span class=cl><span class=c1># An open file may be a regular file, a directory, a block special file, a character special file, an executing text reference, a library, a stream or a network file (Internet socket, NFS file or UNIX domain socket.)</span>
</span></span><span class=line><span class=cl><span class=c1># man lsof for more details </span>
</span></span><span class=line><span class=cl>$ lsof -p <span class=m>654373</span> <span class=c1># list all files opened by node exporter</span>
</span></span><span class=line><span class=cl>COMMAND      PID USER   FD      TYPE   DEVICE SIZE/OFF     NODE NAME
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root  cwd       DIR    252,1     <span class=m>4096</span>  <span class=m>1046028</span> /root/workspace/node_exporter-1.6.1.linux-amd64
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root  rtd       DIR    252,1     <span class=m>4096</span>        <span class=m>2</span> /
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root  txt       REG    252,1 <span class=m>20025119</span>  <span class=m>1046289</span> /root/workspace/node_exporter-1.6.1.linux-amd64/node_exporter
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    0u      CHR    136,5      0t0        <span class=m>8</span> /dev/pts/5
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    1u      CHR    136,5      0t0        <span class=m>8</span> /dev/pts/5
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    2u      CHR    136,5      0t0        <span class=m>8</span> /dev/pts/5
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    3u     IPv6 <span class=m>10182875</span>      0t0      TCP *:9100 <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    4u  a_inode     0,14        <span class=m>0</span>    <span class=m>12477</span> <span class=o>[</span>eventpoll<span class=o>]</span>
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    5r     FIFO     0,13      0t0 <span class=m>10182871</span> pipe
</span></span><span class=line><span class=cl>node_expo <span class=m>655152</span> root    6w     FIFO     0,13      0t0 <span class=m>10182871</span> pipe
</span></span></code></pre></div><h2 id=linux-storage-stack>Linux Storage Stack<a href=#linux-storage-stack class=hanchor arialabel=Anchor>#</a></h2><p><img src=https://chejinying.com/tech/images/Linux-storage-stack-diagram_v6.2/linux_storage_stack.svg alt="linux storage stack">
<a href=https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram>https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram</a></p><h2 id=reference>Reference<a href=#reference class=hanchor arialabel=Anchor>#</a></h2><ul><li><a href=https://developer.ibm.com/tutorials/l-linux-filesystem/>https://developer.ibm.com/tutorials/l-linux-filesystem/</a></li><li><a href="https://www.kernel.org/doc/html/latest/filesystems/ext4/globals.html?highlight=file+system+super+block">super block &ndash; kernel doc</a></li><li><a href="https://www.kernel.org/doc/html/latest/filesystems/vfs.html?highlight=inode">vfs overview &ndash; kernel doc</a></li><li><a href="https://itslinuxfoss.com/what-is-superblock-inode-dentry-and-file/#:~:text=The%20superblock%20is%20the%20data,of%20bytes%20in%20different%20forms.">What is a Superblock, Dentry, Inode and a File?</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://chejinying.com/tech/posts/cpu/ class="button inline prev">&lt; [<span class=button__text>CPU</span>]
</a>::
<a href=https://chejinying.com/tech/posts/memory/ class="button inline next">[<span class=button__text>Memory</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=https://chejinying.com/tech/bundle.min.js></script></div></body></html>