<!doctype html><html lang=en><head><title>alerting rule: grafana vs vmalert ::</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="how alerting rule is implemented in grafana and vmalert"><meta name=keywords content="computer,ai,network"><meta name=robots content="noodp"><link rel=canonical href=https://chejinying.com/tech/posts/alerting_rule_grafana_vs_vmalert/><link rel=stylesheet href=https://chejinying.com/tech/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://chejinying.com/tech/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://chejinying.com/tech/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://chejinying.com/tech/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://chejinying.com/tech/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://chejinying.com/tech/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://chejinying.com/tech/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://chejinying.com/tech/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://chejinying.com/tech/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://chejinying.com/tech/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://chejinying.com/tech/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://chejinying.com/tech/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://chejinying.com/tech/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://chejinying.com/tech/terminal.css><link rel="shortcut icon" href=https://chejinying.com/tech/favicon.png><link rel=apple-touch-icon href=https://chejinying.com/tech/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="alerting rule: grafana vs vmalert"><meta property="og:description" content="how alerting rule is implemented in grafana and vmalert"><meta property="og:url" content="https://chejinying.com/tech/posts/alerting_rule_grafana_vs_vmalert/"><meta property="og:site_name" content><meta property="og:image" content="https://chejinying.com/tech/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-11-24 16:19:22 +0800 +0800"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=https://chejinying.com/tech/><div class=logo>jinying-che:~#</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://chejinying.com/tech/posts>Home</a></li><li><a href=https://chejinying.com/tech/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://chejinying.com/tech/posts>Home</a></li><li><a href=https://chejinying.com/tech/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://chejinying.com/tech/posts/alerting_rule_grafana_vs_vmalert/>alerting rule: grafana vs vmalert</a></h1><div class=post-meta><time class=post-date>2024-11-24</time></div><span class=post-tags>#<a href=https://chejinying.com/tech/tags/grafana/>grafana</a>&nbsp;
#<a href=https://chejinying.com/tech/tags/vmalert/>vmalert</a>&nbsp;</span><div class=post-content><div><p>Let&rsquo;s try to understand how alerting rule is implemented in two open source projects: <strong>grafana</strong> and <strong>vmalert</strong>.</p><h1 id=version>Version<a href=#version class=hanchor arialabel=Anchor>#</a></h1><p>use the latest version of the according source code:</p><ul><li>grafana <a href=https://github.com/grafana/grafana/tree/v11.3.1>v11.3.1</a></li><li>vmalert <a href=https://github.com/VictoriaMetrics/VictoriaMetrics/tree/v1.106.1>v1.106.1</a></li></ul><h1 id=flow>Flow<a href=#flow class=hanchor arialabel=Anchor>#</a></h1><h3 id=grafana>grafana<a href=#grafana class=hanchor arialabel=Anchor>#</a></h3><p><img src=https://chejinying.com/tech/images/grafana_alert.png alt="grafana alert"></p><ul><li>Scheduler -> fetch alerting rules -> start <em>goroutine</em> for each alerting rule<ul><li><code>pkg/services/ngalert/schedule/schedule.go:280</code></li></ul></li><li>Scheduler -> send evaluation event(when internal elapsed) -> goroutine -> evaluation<ul><li><code>pkg/services/ngalert/schedule/alert_rule.go:242</code></li></ul></li><li>Schedduler -> stop the goroutine (alerting rule delted) according to the heartbeat<ul><li><code>pkg/services/ngalert/schedule/alert_rule.go:355</code></li></ul></li></ul><h3 id=vmalert>vmalert<a href=#vmalert class=hanchor arialabel=Anchor>#</a></h3><p><img src=https://chejinying.com/tech/images/vmalert.png alt=vmalert></p><ul><li>configReload (cron job by configCheckInterval) -> loading alerting rule files -> <code>[]config.Group</code></li><li><code>[]config.Group</code> -> diff -> manager -> <strong>start</strong> the new <code>rule.Group</code> and <strong>delete</strong> the old <code>rule.Group</code></li><li>start <code>rule.Group</code> per <em>goroutine</em> -> executor -> execConcurrently (<code>[]rule.Rule</code>) -> rule.exec() per <em>goroutine</em></li></ul><h1 id=evaluation>Evaluation<a href=#evaluation class=hanchor arialabel=Anchor>#</a></h1><h3 id=grafana-1>grafana<a href=#grafana-1 class=hanchor arialabel=Anchor>#</a></h3><blockquote><p>code entrance: <code>pkg/services/ngalert/schedule/alert_rule.go:327</code></p></blockquote><p>evalCh -> event -> alertRule -> evaluate:</p><ul><li>eval.EvaluatorFactory -> create -> ConditionEvaluator (<code>BuildPipeline -> buildDependencyGraph -> buildExecutionOrder -> []Node</code>)</li><li>ConditionEvaluator -> Evaluate<ul><li>expressionExecutor -> ExecutePipeline (DataPipeline []Node)<ul><li>DataPipeline -> excute -> for loop []Node -> backend.QueryDataResponse</li></ul></li><li>backend.QueryDataResponse -> EvaluateAlert -> Results</li></ul></li><li>Results -> stateManager.ProcessEvalResults</li></ul><h3 id=vmalert-1>vmalert<a href=#vmalert-1 class=hanchor arialabel=Anchor>#</a></h3><blockquote><p>code entrance: <code>app/vmalert/rule/group.go:311</code></p></blockquote><p>rule.Group -> exec(rule.Rule) concurrently:</p><ul><li>executor instant query (for now) -> response (label set of Metric that needs alerting)<ul><li>response -> update AlertingRule.alerts</li></ul></li><li>alerts -> executor.Notifier</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Querier interface wraps Query and QueryRange methods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Querier</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Query is used for the rule evaluation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>Query</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>ts</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Result</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// QueryRange is used for rule replay </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>QueryRange</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>from</span><span class=p>,</span><span class=w> </span><span class=nx>to</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Result</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=data-structure>Data Structure<a href=#data-structure class=hanchor arialabel=Anchor>#</a></h1><h3 id=grafana-2>grafana<a href=#grafana-2 class=hanchor arialabel=Anchor>#</a></h3><p>alert rule</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/services/ngalert/models/alert_rule.go:247</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// AlertRule is the model for alert rules in unified alerting.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>AlertRule</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ID</span><span class=w>              </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>OrgID</span><span class=w>           </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Title</span><span class=w>           </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Condition</span><span class=w>       </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Data</span><span class=w>            </span><span class=p>[]</span><span class=nx>AlertQuery</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Updated</span><span class=w>         </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>IntervalSeconds</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Version</span><span class=w>         </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>UID</span><span class=w>             </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>NamespaceUID</span><span class=w>    </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>DashboardUID</span><span class=w>    </span><span class=o>*</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>PanelID</span><span class=w>         </span><span class=o>*</span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>RuleGroup</span><span class=w>       </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>RuleGroupIndex</span><span class=w>  </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Record</span><span class=w>          </span><span class=o>*</span><span class=nx>Record</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>NoDataState</span><span class=w>     </span><span class=nx>NoDataState</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ExecErrState</span><span class=w>    </span><span class=nx>ExecutionErrorState</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// ideally this field should have been apimodels.ApiDuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// but this is currently not possible because of circular dependencies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>For</span><span class=w>                  </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Annotations</span><span class=w>          </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Labels</span><span class=w>               </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>IsPaused</span><span class=w>             </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>NotificationSettings</span><span class=w> </span><span class=p>[]</span><span class=nx>NotificationSettings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Metadata</span><span class=w>             </span><span class=nx>AlertRuleMetadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// AlertQuery represents a single query associated with an alert definition.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>AlertQuery</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// RefID is the unique identifier of the query, set by the frontend call.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>RefID</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;refId&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// QueryType is an optional identifier for the type of query.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// It can be used to distinguish different types of queries.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>QueryType</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;queryType&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// RelativeTimeRange is the relative Start and End of the query as sent by the frontend.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>RelativeTimeRange</span><span class=w> </span><span class=nx>RelativeTimeRange</span><span class=w> </span><span class=s>`json:&#34;relativeTimeRange&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Grafana data source unique identifier; it should be &#39;__expr__&#39; for a Server Side Expression operation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>DatasourceUID</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;datasourceUid&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// JSON is the raw JSON query and includes the above properties as well as custom properties.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Model</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nx>RawMessage</span><span class=w> </span><span class=s>`json:&#34;model&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>modelProps</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Node</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/expr/graph.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>const</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeCMDNode is a NodeType for expression commands.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeCMDNode</span><span class=w> </span><span class=nx>NodeType</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>iota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeDatasourceNode is a NodeType for datasource queries.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeDatasourceNode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeMLNode is a NodeType for Machine Learning queries.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeMLNode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// pkg/expr/nodes.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>const</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeUnknown is the CMDType for an unrecognized expression type.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeUnknown</span><span class=w> </span><span class=nx>CommandType</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>iota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeMath is the CMDType for a math expression.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeMath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeReduce is the CMDType for a reduction expression.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeReduce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeResample is the CMDType for a resampling expression.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeResample</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeClassicConditions is the CMDType for the classic condition operation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeClassicConditions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeThreshold is the CMDType for checking if a threshold has been crossed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeThreshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TypeSQL is the CMDType for running SQL expressions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>TypeSQL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=vmalert-2>vmalert<a href=#vmalert-2 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// app/vmalert/rule/alerting.go:24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// AlertingRule is basic alert entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>AlertingRule</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Type</span><span class=w>          </span><span class=nx>config</span><span class=p>.</span><span class=nx>Type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>RuleID</span><span class=w>        </span><span class=kt>uint64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Name</span><span class=w>          </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Expr</span><span class=w>          </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>For</span><span class=w>           </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>KeepFiringFor</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Labels</span><span class=w>        </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Annotations</span><span class=w>   </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>GroupID</span><span class=w>       </span><span class=kt>uint64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>GroupName</span><span class=w>     </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>File</span><span class=w>          </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>EvalInterval</span><span class=w>  </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Debug</span><span class=w>         </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>q</span><span class=w> </span><span class=nx>datasource</span><span class=p>.</span><span class=nx>Querier</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>alertsMu</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// stores list of active alerts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>alerts</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>uint64</span><span class=p>]</span><span class=o>*</span><span class=nx>notifier</span><span class=p>.</span><span class=nx>Alert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// state stores recent state changes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// during evaluations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>state</span><span class=w> </span><span class=o>*</span><span class=nx>ruleState</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>metrics</span><span class=w> </span><span class=o>*</span><span class=nx>alertingRuleMetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// app/vmalert/rule/group.go:40</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Group is an entity for grouping rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Group</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mu</span><span class=w>         </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Name</span><span class=w>       </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>File</span><span class=w>       </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Rules</span><span class=w>      </span><span class=p>[]</span><span class=nx>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Type</span><span class=w>       </span><span class=nx>config</span><span class=p>.</span><span class=nx>Type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Interval</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>EvalOffset</span><span class=w> </span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// EvalDelay will adjust timestamp for rule evaluation requests to compensate intentional query delay from datasource.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// see https://github.com/VictoriaMetrics/VictoriaMetrics/issues/5155</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>EvalDelay</span><span class=w>      </span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Limit</span><span class=w>          </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Concurrency</span><span class=w>    </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Checksum</span><span class=w>       </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>LastEvaluation</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Labels</span><span class=w>          </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Params</span><span class=w>          </span><span class=nx>url</span><span class=p>.</span><span class=nx>Values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Headers</span><span class=w>         </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>NotifierHeaders</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>doneCh</span><span class=w>     </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>finishedCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// channel accepts new Group obj</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// which supposed to update current group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>updateCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// evalCancel stores the cancel fn for interrupting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// rules evaluation. Used on groups update() and close().</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>evalCancel</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>CancelFunc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>metrics</span><span class=w> </span><span class=o>*</span><span class=nx>groupMetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// evalAlignment will make the timestamp of group query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// requests be aligned with interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>evalAlignment</span><span class=w> </span><span class=o>*</span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://chejinying.com/tech/posts/histogram/ class="button inline prev">&lt; [<span class=button__text>How histogram is calculated in Prometheus</span>]
</a>::
<a href=https://chejinying.com/tech/posts/vps_setup/ class="button inline next">[<span class=button__text>vps setup</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=https://chejinying.com/tech/bundle.min.js></script></div></body></html>