<!doctype html><html lang=en><head><title>Memory :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Linux Memroy Overview"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://jinying-che.github.io/posts/memory/><link rel=stylesheet href=https://jinying-che.github.io/styles.css><link rel="shortcut icon" href=https://jinying-che.github.io/img/theme-colors/green.png><link rel=apple-touch-icon href=https://jinying-che.github.io/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Memory"><meta property="og:description" content="Linux Memroy Overview"><meta property="og:url" content="https://jinying-che.github.io/posts/memory/"><meta property="og:site_name" content><meta property="og:image" content="https://jinying-che.github.io/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-09-28 16:10:39 +0800 +0800"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>jinying-che:~#</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/posts>Home</a></li><li><a href=/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/posts>Home</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://jinying-che.github.io/posts/memory/>Memory</a></h1><div class=post-meta><time class=post-date>2023-09-28 ::</time></div><span class=post-tags>#<a href=https://jinying-che.github.io/tags/linux/>linux</a>&nbsp;</span><div class=post-content><div><h2 id=virtual-memory>Virtual Memory<a href=#virtual-memory class=hanchor arialabel=Anchor>&#8983;</a></h2><ol><li>Virtual memory is an abstraction for memory management by operation system</li><li>Each process operates the virtual memory (virtual address), which is mapped to physical memory by memory management unit (MMU) in CPU</li><li>The physical memory is only allocated to process when memory is firstly accessed. (e.g. <code>mmap()</code> and <code>brk()</code> in C just allocate the virtual memory first, hence you can see <code>VIRT</code> in <code>top</code> command is usually much higher than <code>RES</code>)</li><li>Virtual maps to physical memory and disk (swap)</li><li>Virtual memory for one process includes both user space and kernel space.</li></ol><p><img src=/images/virtual_memory.png alt="virtual memory"></p><h2 id=buffer-vs-cache>Buffer vs Cache<a href=#buffer-vs-cache class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>Buffer: the memory used for the disk (both read and write)</li><li>Cache: the memory used for the file (both read and write)</li></ul><pre tabindex=0><code>Common Mistake: Buffer is for write only, whereas Cache is for read only --&gt; WRONG!
</code></pre><h2 id=reclaim-memory>Reclaim Memory<a href=#reclaim-memory class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Operation system will try to reclaim the memory when the resource is lack:</p><ol><li>LRU（Least Recently Used）</li><li>Swap the less used memory to disk</li><li>OOM (Out of Memory): kill the process who takes up lots of memory</li></ol><h2 id=allocating-kernel-memory-tbd>Allocating kernel memory (TBD)<a href=#allocating-kernel-memory-tbd class=hanchor arialabel=Anchor>&#8983;</a></h2><h4 id=buddy-system>Buddy System<a href=#buddy-system class=hanchor arialabel=Anchor>&#8983;</a></h4><p>The buddy system is a memory allocation algorithm that works by dividing memory into blocks of a fixed size, with each block being a power of two in size.</p><p><strong>Drawback</strong>: The main drawback in buddy system is internal fragmentation as larger block of memory is acquired then required. For example if a 36 kb request is made then it can only be satisfied by 64 kb segment and remaining memory is wasted.</p><h4 id=slab-system>Slab System<a href=#slab-system class=hanchor arialabel=Anchor>&#8983;</a></h4><p>The slab system is a memory allocation algorithm that is designed specifically for kernel memory. It works by dividing memory into fixed-size caches or slabs, each of which contains a set of objects of the same type</p><h2 id=troubleshooting>TroubleShooting<a href=#troubleshooting class=hanchor arialabel=Anchor>&#8983;</a></h2><h4 id=1-tophtop>1. top/htop<a href=#1-tophtop class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># top, press M (order by memory)</span>
</span></span><span style=display:flex><span>$ top 
</span></span><span style=display:flex><span>%Cpu<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>:  0.7 us,  0.7 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span style=display:flex><span>MiB Mem : 35.8/957.5    <span style=color:#f92672>[||||||||||||||||||||||||||||||||||||</span>                                                                <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>MiB Swap:  4.1/2400.0   <span style=color:#f92672>[||||</span>                                                                                                <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>428</span> root      rt   <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>289312</span>  <span style=color:#ae81ff>27100</span>   <span style=color:#ae81ff>9072</span> S   0.3   2.8   4:20.42 multipathd
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>745</span> root      <span style=color:#ae81ff>20</span>   <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1209328</span>   <span style=color:#ae81ff>7900</span>   <span style=color:#ae81ff>1832</span> S   0.3   0.8  15:47.03 containerd
</span></span><span style=display:flex><span> <span style=color:#ae81ff>359212</span> root      <span style=color:#ae81ff>20</span>   <span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>15424</span>   <span style=color:#ae81ff>9208</span>   <span style=color:#ae81ff>7600</span> S   0.3   0.9   0:00.01 sshd
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>1</span> root      <span style=color:#ae81ff>20</span>   <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>167692</span>   <span style=color:#ae81ff>8560</span>   <span style=color:#ae81ff>5560</span> S   0.0   0.9   1:30.35 systemd
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>2</span> root      <span style=color:#ae81ff>20</span>   <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> S   0.0   0.0   0:00.37 kthreadd
</span></span></code></pre></div><p>Run <code>man top</code>:</p><ul><li><code>VIRT</code>: The total amount of virtual memory used by the task. It includes all code, data and shared libraries plus pages that have been swapped out and pages that have been mapped but not used.</li><li><code>RES</code>: A subset of the virtual address space (VIRT) representing the non-swapped <strong>physical memory</strong> a task is currently using.</li><li><code>SHR</code>: A subset of resident memory (RES) that may be used by other processes.</li><li><code>%MEM</code>: A task&rsquo;s currently resident share of available physical memory.</li></ul><h4 id=2-free>2. free<a href=#2-free class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># free displays the total amount of free and used physical and swap memory in the system, as well as the buffers and caches used by the kernel. The information is gathered by parsing /proc/meminfo</span>
</span></span><span style=display:flex><span>$ free
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>               total        used        free      shared  buff/cache   available
</span></span><span style=display:flex><span>Mem:          <span style=color:#ae81ff>980508</span>      <span style=color:#ae81ff>183624</span>       <span style=color:#ae81ff>74136</span>         <span style=color:#ae81ff>348</span>      <span style=color:#ae81ff>722748</span>      <span style=color:#ae81ff>631876</span>
</span></span><span style=display:flex><span>Swap:        <span style=color:#ae81ff>2457596</span>      <span style=color:#ae81ff>101948</span>     <span style=color:#ae81ff>2355648</span>
</span></span></code></pre></div><p>Run <code>man free</code>:</p><ul><li><code>total</code>: Total installed memory (MemTotal and SwapTotal in /proc/meminfo)</li><li><code>used</code>: Used memory (calculated as total - free - buffers - cache)</li><li><code>free</code>: Unused memory (MemFree and SwapFree in /proc/meminfo)</li><li><code>shared</code>: Memory used (mostly) by tmpfs (Shmem in /proc/meminfo)</li><li><code>buffers</code>: Memory used by kernel buffers (Buffers in /proc/meminfo)</li><li><code>cache</code>: Memory used by the page cache and slabs (Cached and SReclaimable in /proc/meminfo)</li><li><code>buff/cache</code>: Sum of buffers and cache</li><li><code>available</code>: Estimation of how much memory is available for starting new applications, without swapping.</li></ul><h4 id=3-vmstat>3. vmstat<a href=#3-vmstat class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># usage: vmstat [options] [delay [count]]</span>
</span></span><span style=display:flex><span>$ vmstat -t <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> <span style=color:#75715e># report virtual memory statistics per 2 second, total 5 </span>
</span></span><span style=display:flex><span>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- -----timestamp-----
</span></span><span style=display:flex><span> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st                 UTC
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>101948</span>  <span style=color:#ae81ff>72904</span>  <span style=color:#ae81ff>85464</span> <span style=color:#ae81ff>641460</span>    <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>6</span>    <span style=color:#ae81ff>14</span>   <span style=color:#ae81ff>10</span>    <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>100</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> 2023-09-28 14:41:49
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>101948</span>  <span style=color:#ae81ff>72904</span>  <span style=color:#ae81ff>85472</span> <span style=color:#ae81ff>641460</span>    <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>226</span>   <span style=color:#ae81ff>50</span>   <span style=color:#ae81ff>85</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>100</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> 2023-09-28 14:41:51
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>101948</span>  <span style=color:#ae81ff>72904</span>  <span style=color:#ae81ff>85472</span> <span style=color:#ae81ff>641460</span>    <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>4</span>   <span style=color:#ae81ff>60</span>  <span style=color:#ae81ff>104</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>99</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> 2023-09-28 14:41:53
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>101948</span>  <span style=color:#ae81ff>72904</span>  <span style=color:#ae81ff>85472</span> <span style=color:#ae81ff>641460</span>    <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>41</span>   <span style=color:#ae81ff>62</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>100</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> 2023-09-28 14:41:55
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>101948</span>  <span style=color:#ae81ff>72904</span>  <span style=color:#ae81ff>85472</span> <span style=color:#ae81ff>641460</span>    <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>12</span>   <span style=color:#ae81ff>39</span>   <span style=color:#ae81ff>76</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>99</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span> 2023-09-28 14:41:57
</span></span></code></pre></div><p>Run <code>man vmstat</code>:</p><ul><li><p>Memory</p><ul><li>These are affected by the &ndash;unit option.</li><li>swpd: the amount of swap memory used.</li><li>free: the amount of idle memory.</li><li>buff: the amount of memory used as buffers.</li><li>cache: the amount of memory used as cache.</li><li>inact: the amount of inactive memory. (-a option)</li><li>active: the amount of active memory. (-a option)</li></ul></li><li><p>Swap</p><ul><li>These are affected by the &ndash;unit option.</li><li>si: Amount of memory swapped in from disk (/s).</li><li>so: Amount of memory swapped to disk (/s).</li></ul></li><li><p>IO</p><ul><li>bi: Blocks received from a block device (blocks/s).</li><li>bo: Blocks sent to a block device (blocks/s).</li></ul></li><li><p>System</p><ul><li>in: The number of interrupts per second, including the clock.</li><li>cs: The number of context switches per second.</li></ul></li><li><p>CPU</p><ul><li>These are percentages of total CPU time.</li><li>us: Time spent running non-kernel code. (user time, including nice time)</li><li>sy: Time spent running kernel code. (system time)</li><li>id: Time spent idle. Prior to Linux 2.5.41, this includes IO-wait time.</li><li>wa: Time spent waiting for IO. Prior to Linux 2.5.41, included in idle.</li><li>st: Time stolen from a virtual machine. Prior to Linux 2.6.11, unknown.</li></ul></li></ul><h4 id=4-procmeminfo>4. /proc/meminfo<a href=#4-procmeminfo class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># This file reports statistics about memory usage on the system.</span>
</span></span><span style=display:flex><span>$ cat /proc/meminfo
</span></span><span style=display:flex><span><span style=color:#75715e># show the first several rows only</span>
</span></span><span style=display:flex><span>MemTotal:         <span style=color:#ae81ff>980508</span> kB
</span></span><span style=display:flex><span>MemFree:           <span style=color:#ae81ff>74136</span> kB
</span></span><span style=display:flex><span>MemAvailable:     <span style=color:#ae81ff>634416</span> kB
</span></span><span style=display:flex><span>Buffers:           <span style=color:#ae81ff>85092</span> kB
</span></span><span style=display:flex><span>Cached:           <span style=color:#ae81ff>571860</span> kB
</span></span><span style=display:flex><span>SwapCached:         <span style=color:#ae81ff>9556</span> kB
</span></span><span style=display:flex><span>Active:           <span style=color:#ae81ff>408724</span> kB
</span></span><span style=display:flex><span>Inactive:         <span style=color:#ae81ff>305408</span> kB
</span></span><span style=display:flex><span>Active<span style=color:#f92672>(</span>anon<span style=color:#f92672>)</span>:      <span style=color:#ae81ff>21352</span> kB
</span></span><span style=display:flex><span>Inactive<span style=color:#f92672>(</span>anon<span style=color:#f92672>)</span>:    <span style=color:#ae81ff>45240</span> kB
</span></span><span style=display:flex><span>Active<span style=color:#f92672>(</span>file<span style=color:#f92672>)</span>:     <span style=color:#ae81ff>387372</span> kB
</span></span><span style=display:flex><span>Inactive<span style=color:#f92672>(</span>file<span style=color:#f92672>)</span>:   <span style=color:#ae81ff>260168</span> kB
</span></span><span style=display:flex><span>Unevictable:       <span style=color:#ae81ff>27620</span> kB
</span></span><span style=display:flex><span>Mlocked:           <span style=color:#ae81ff>27620</span> kB
</span></span><span style=display:flex><span>SwapTotal:       <span style=color:#ae81ff>2457596</span> kB
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=5-memleak>5. memleak<a href=#5-memleak class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># memleak - Print a summary of outstanding allocations and their call stacks to detect memory leaks. Uses Linux eBPF/bcc.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install: https://github.com/iovisor/bcc/blob/master/INSTALL.md#installing-bcc</span>
</span></span><span style=display:flex><span>$ /usr/sbin/memleak-bpfcc -p <span style=color:#66d9ef>$(</span>pidof systemd<span style=color:#66d9ef>)</span> <span style=color:#75715e># systemd no memory leak</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Attaching to pid 212971, Ctrl+C to quit.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>04:34:51<span style=color:#f92672>]</span> Top <span style=color:#ae81ff>10</span> stacks with outstanding allocations:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>04:34:56<span style=color:#f92672>]</span> Top <span style=color:#ae81ff>10</span> stacks with outstanding allocations:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>04:35:01<span style=color:#f92672>]</span> Top <span style=color:#ae81ff>10</span> stacks with outstanding allocations:
</span></span></code></pre></div><h2 id=reference>Reference<a href=#reference class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><a href=https://www.geeksforgeeks.org/operating-system-allocating-kernel-memory-buddy-system-slab-system/>https://www.geeksforgeeks.org/operating-system-allocating-kernel-memory-buddy-system-slab-system/</a></li><li><a href=https://www.kernel.org/doc/html/next/admin-guide/mm/concepts.html>https://www.kernel.org/doc/html/next/admin-guide/mm/concepts.html</a></li><li><a href=https://github.com/iovisor/bcc>BPF Compiler Collection</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://jinying-che.github.io/posts/file_system/><span class=button__icon>←</span>
<span class=button__text>File System</span>
</a></span><span class="button next"><a href=https://jinying-che.github.io/posts/network/dns/><span class=button__text>DNS</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>